<script setup>
import { onMounted } from 'vue';
import { useWorkshopStore } from '@/stores/workshops'

const emit = defineEmits(["openDrawer", "closeDrawer"])
const store = useWorkshopStore()
const RED = "#A2000289"
const GREEN = "#4F843A89"
const BLUE = "#015E8989"
const ORANGE = "#AE690189"
const workshopBuildings = [
    {
        id: "ELAN2B",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8817147762396473, 49.67735008686142],
                            [-1.8814730604734393, 49.677358730014134],
                            [-1.8814729720512275, 49.677348097449055],
                            [-1.8813013613170142, 49.677353537867305],
                            [-1.8813148868628105, 49.67750424686204],
                            [-1.8817247699921609, 49.67748702403213],
                        ]
                    ]
                }
            }
        },
        color: RED
    },
    {
        id: "DFG",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.88061, 49.67781],
                            [-1.880741316248077, 49.67780458627729],
                            [-1.8807776983494762, 49.67828248370279],
                            [-1.8806454641094774, 49.67828621795064],
                        ]
                    ]
                }
            }
        },
        color: GREEN
    },
    {
        id: "DEG",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8797039531502548, 49.67822806861096],
                            [-1.880636396239538, 49.67819368590028],
                            [-1.8806549339703906, 49.678415707767385],
                            [-1.8797221736051313, 49.678452199486344],
                        ]
                    ]
                }
            }
        },
        color: GREEN
    },
    {
        id: "MAPu",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8840082255178459, 49.67927021700302],
                            [-1.8839866262199791, 49.67927143252277],
                            [-1.8839861131938562, 49.679287216272655],
                            [-1.8837581497666065, 49.679291971391336],
                            [-1.8837583037924617, 49.67928184473527],
                            [-1.8836992141786482, 49.67928340943868],
                            [-1.883699383193914, 49.67929571422789],
                            [-1.8835918494131647, 49.6792971321415],
                            [-1.8836327582006902, 49.67977990753576],
                            [-1.883573445787846, 49.67978165931922],
                            [-1.883578659828629, 49.67982508702315],
                            [-1.8836858652579167, 49.67982151849958],
                            [-1.8836781378705894, 49.6797383581459],
                            [-1.8840560617869926, 49.67972263406213],
                            [-1.8840545719326656, 49.67972206409209],
                            [-1.8840211608126083, 49.67928346738594],
                            [-1.8840080694676544, 49.679283450371344],
                        ]
                    ]
                }
            }
        },
        color: GREEN
    },
    {
        id: "HAONORD",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8790902742716185, 49.6786895750806],
                            [-1.8791032282576339, 49.67883654893035],
                            [-1.879014749644199, 49.67883982660652],
                            [-1.8790394386934395, 49.67914259186074],
                            [-1.8793463604658314, 49.67913089153626],
                            [-1.8793461449882614, 49.67913761830826],
                            [-1.879498793146496, 49.67913248816629],
                            [-1.8794725633381972, 49.6788257044127],
                            [-1.8794200902394493, 49.67882736499132],
                            [-1.8794084671797293, 49.678660871054234],
                            [-1.879303304482022, 49.67866306983072],
                            [-1.8793047785369197, 49.67868111812888],
                        ]
                    ]
                }
            }
        },
        color: ORANGE
    },
    {
        id: "HAOSUD",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8790766344112058, 49.67851985100191],
                            [-1.879635728679773, 49.67850081688454],
                            [-1.8796467047096996, 49.67866226658791],
                            [-1.8796515386793544, 49.678662311521094],
                            [-1.8796653611239549, 49.67878375779776],
                            [-1.8794693830500933, 49.67879046708029],
                            [-1.8794725633381972, 49.6788257044127],
                            [-1.8794200902394493, 49.67882736499132],
                            [-1.8794084671797293, 49.678660871054234],
                            [-1.879303304482022, 49.67866306983072],
                            [-1.8793047785369197, 49.67868111812888],
                            [-1.8790902742716185, 49.6786895750806],
                        ]
                    ]
                }
            }
        },
        color: ORANGE
    },
    {
        id: "HAOSILO",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8790766344112058, 49.67851985100191],
                            [-1.8792202344118891, 49.678514998173966],
                            [-1.8792067244870339, 49.67841214740349],
                            [-1.879096486341524, 49.67841542841862],
                            [-1.879079279966959, 49.678154679504274],
                            [-1.8787426232188977, 49.678165800073515],
                            [-1.8787706043542585, 49.678484881015606],
                            [-1.87898018772853, 49.67847756457536],
                            [-1.8789900907111416, 49.67858782415149],
                            [-1.8790072710544052, 49.67858715918737],
                            [-1.8790103984499353, 49.67861748704519],
                            [-1.8790841969505152, 49.678614645975216],
                        ]
                    ]
                }
            }
        },
        color: ORANGE
    },
    {
        id: "HAONVFILT",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8787706043542585, 49.678484881015606],
                            [-1.87898018772853, 49.67847756457536],
                            [-1.8789900907111416, 49.67858782415149],
                            [-1.8787803230541442, 49.67859617666193],
                        ]
                    ]
                }
            }
        },
        color: ORANGE
    },
    {
        id: "HADE",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8797221736051313, 49.678452199486344],
                            [-1.8805689744796155, 49.678419273100474],
                            [-1.8805827088049512, 49.67855808186749],
                            [-1.8806872629070597, 49.67855468799206],
                            [-1.880697871156201, 49.67867257090177],
                            [-1.8806045830536675, 49.67867431709894],
                            [-1.8805989070375801, 49.67860506928096],
                            [-1.8805854406429034, 49.67860490788698],
                            [-1.8806306394124874, 49.67911870879229],
                            [-1.880292939027015, 49.67913080869499],
                            [-1.8802955977960778, 49.679198450892954],
                            [-1.8801429418875841, 49.67920548383606],
                            [-1.880140412180026, 49.67913604869989],
                            [-1.8798693107704025, 49.67914626743453],
                            [-1.879861160538212, 49.67906305424896],
                            [-1.8798532806679304, 49.67906304455403],
                            [-1.8798532544377338, 49.679059463384306],
                            [-1.8798020031841531, 49.67906126948162],
                            [-1.8797997366377501, 49.679033509309676],
                            [-1.8796494331764961, 49.67904063702295],
                            [-1.879635755508076, 49.67887907464703],
                            [-1.8797619192239097, 49.67887571232097],
                            [-1.8797404266191506, 49.67865890556695],
                            [-1.8798208976480169, 49.678655113943194],
                            [-1.8798102191170187, 49.67850062412268],
                            [-1.879727349807979, 49.67850078699752],
                        ]
                    ]
                }
            }
        },
        color: GREEN
    },
    {
        id: "HAPF",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8825593653807573, 49.67827325164521],
                            [-1.8825677229500286, 49.678380871131225],
                            [-1.8826293690634373, 49.67837929243569],
                            [-1.8826293193932884, 49.67834621585055],
                            [-1.8827363557607555, 49.67834446436572],
                            [-1.8827417969677924, 49.67847473864748],
                            [-1.8826400406625226, 49.67847810135973],
                            [-1.8826344740690502, 49.678434625375615],
                            [-1.8825727832612529, 49.678436577920195],
                            [-1.8825779948826664, 49.67851960361139],
                            [-1.882401247416567, 49.678526630653096],
                            [-1.882401247416567, 49.678563186544466],
                            [-1.8823205926283322, 49.67856497665841],
                            [-1.8823179104192889, 49.6785303733092],
                            [-1.8822780125598797, 49.67853015636018],
                            [-1.8822774714840023, 49.678509581477925],
                            [-1.882151742936486, 49.678510991646846],
                            [-1.8821599572016225, 49.678568374639156],
                            [-1.8822025372700466, 49.67856663904868],
                            [-1.8822160250674358, 49.678677611607924],
                            [-1.882392922410645, 49.67867274765575],
                            [-1.8824010164756828, 49.67876466164256],
                            [-1.8822994278094427, 49.67876986839261],
                            [-1.8823016071042957, 49.67883571203703],
                            [-1.8823877730685865, 49.67883408492989],
                            [-1.882387605430523, 49.67884276283391],
                            [-1.8824278385660307, 49.67884102725327],
                            [-1.8824359209223473, 49.67893112180886],
                            [-1.8823956877868113, 49.67893285738637],
                            [-1.8824064425980964, 49.67904904450063],
                            [-1.8822484270201016, 49.679054394629986],
                            [-1.8822482236958251, 49.67906127719934],
                            [-1.8821170799533036, 49.67906662732733],
                            [-1.882121848745527, 49.679123833153824],
                            [-1.8820414629143727, 49.67912546791311],
                            [-1.8820419222441274, 49.67913765429279],
                            [-1.8818944716612975, 49.679144787785475],
                            [-1.8818920259730305, 49.67911186502539],
                            [-1.881950592793828, 49.67910993303656],
                            [-1.881948066381966, 49.679073373849775],
                            [-1.8817310135211471, 49.67908033992751],
                            [-1.881714622828099, 49.678873813860235],
                            [-1.881625942291862, 49.67887554943974],
                            [-1.881615167389242, 49.6786969783507],
                            [-1.8813899286316484, 49.6787002670421],
                            [-1.8813794994945, 49.678556290202806],
                            [-1.881609691451871, 49.67854943683142],
                            [-1.8816100267279978, 49.678554643604485],
                            [-1.8816849609407882, 49.67855290802177],
                            [-1.8816849609407882, 49.67856321309162],
                            [-1.8817598584188602, 49.678559904403954],
                            [-1.881760026056952, 49.67858062301406],
                            [-1.881899659466086, 49.678575296014685],
                            [-1.881881065606052, 49.678349702521814],
                            [-1.8820578970750432, 49.67834122112134],
                            [-1.8820553622132081, 49.678289235374564],
                            [-1.8822564208523715, 49.6782788087871],
                            [-1.882256588490435, 49.678283690163425],
                        ]
                    ]
                }
            }
        },
        color: GREEN
    },
    {
        id: "MAU",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.883593252409895, 49.679311272057134],
                            [-1.8835493312369351, 49.67931300762103],
                            [-1.883546552014252, 49.67928528214517],
                            [-1.8835034226031837, 49.67928722565682],
                            [-1.8835089546542747, 49.67934429943864],
                            [-1.8833882552486614, 49.679347662091374],
                            [-1.8833853914474616, 49.67928880721601],
                            [-1.883291677705671, 49.679292116301355],
                            [-1.8832941833484256, 49.67934948955025],
                            [-1.8828838645212045, 49.6793634672818],
                            [-1.8828973174119312, 49.67951423900277],
                            [-1.88280085036331, 49.67951777869928],
                            [-1.8827983357923586, 49.67950226716073],
                            [-1.8827795135166525, 49.67950231246459],
                            [-1.882782087400983, 49.679594234535045],
                            [-1.8828062867459607, 49.679592470122],
                            [-1.882806242315553, 49.67958019052875],
                            [-1.8829026342017698, 49.67957867191868],
                            [-1.8829108956913672, 49.67972254938252],
                            [-1.883355946685299, 49.67970692783524],
                            [-1.8833589641704407, 49.67971213448442],
                            [-1.8834070172145516, 49.679710387238885],
                            [-1.8834070172145516, 49.67970366198341],
                            [-1.883625449606626, 49.67969661131417],
                        ]
                    ]
                }
            }
        },
        color: GREEN
    },
    {
        id: "SILO130",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8964262718158125, 49.68294019411704],
                            [-1.8961797172527213, 49.68295237052993],
                            [-1.8961662768351175, 49.68280316889664],
                            [-1.8964078080358888, 49.68279261806023],
                        ]
                    ]
                }
            }
        },
        color: BLUE
    },
    {
        id: "SILO115",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8882672967231713, 49.67815714000173],
                            [-1.8882726447733376, 49.67825081493501],
                            [-1.8879079518586082, 49.678264537500695],
                            [-1.8878997114570666, 49.67816915061519],
                            [-1.8879480074181458, 49.67816741239426],
                            [-1.887948007411751, 49.67815028209128],
                            [-1.8880256931803956, 49.67814850279268],
                            [-1.8880339074455605, 49.67816564189266],
                        ]
                    ]
                }
            }
        },
        color: BLUE
    },
    {
        id: "RCB",
        body: {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    'coordinates': [
                        [
                            [-1.8861644098556667, 49.67802699477656],
                            [-1.8859122655954081, 49.678035823989575],
                            [-1.8859308703295312, 49.678257750131166],
                            [-1.885836977267303, 49.678261319627524],
                            [-1.88584767475092, 49.67838623222522],
                            [-1.8857671810732484, 49.678387977217255],
                            [-1.8857540507612214, 49.678235300734855],
                            [-1.8856628425486974, 49.67823876122017],
                            [-1.8856521137135474, 49.6782336628884],
                            [-1.8856197595670494, 49.67823529001561],
                            [-1.8856091290846848, 49.678103354420756],
                            [-1.8855449237097446, 49.67810682563706],
                            [-1.8855422415007013, 49.678084262742516],
                            [-1.8854533045693245, 49.67808931349816],
                            [-1.885459006555294, 49.678152048389535],
                            [-1.8854831464365986, 49.6781503127842],
                            [-1.8854856803039581, 49.67821793054085],
                            [-1.885552766008658, 49.678216088333414],
                            [-1.885552589259845, 49.67824035731513],
                            [-1.8852711360924275, 49.678249242212786],
                            [-1.8852686436709973, 49.67822838298207],
                            [-1.8852923093252514, 49.67822840155239],
                            [-1.8852951278270496, 49.67820585254958],
                            [-1.8852202135068978, 49.67820907840235],
                            [-1.885212176201719, 49.678084297715316],
                            [-1.8850242569526756, 49.67809108947915],
                            [-1.8850299060979125, 49.67820393255684],
                            [-1.885102215413042, 49.678202346620054],
                            [-1.8851128512608852, 49.67832016674873],
                            [-1.8850996078537605, 49.67832201082234],
                            [-1.8850997358259463, 49.67834624351471],
                            [-1.8851183436511292, 49.6783463519896],
                            [-1.8851207001351327, 49.67842955166378],
                            [-1.8850994101009348, 49.678431612683255],
                            [-1.885099232816259, 49.67845379523828],
                            [-1.8850724495573274, 49.67845572265111],
                            [-1.8850700733925976, 49.678414127053884],
                            [-1.884970562828613, 49.678417497169704],
                            [-1.884978969759885, 49.67848337363739],
                            [-1.8851289324556149, 49.67847819078668],
                            [-1.885142244243383, 49.678655325479156],
                            [-1.8854079805949198, 49.67864830025161],
                            [-1.8854133449980566, 49.67870039119492],
                            [-1.8854643069564077, 49.67869865561181],
                            [-1.8854590054723417, 49.678646374207375],
                            [-1.8856921900117811, 49.67863628610547],
                            [-1.8857029476874914, 49.67874382291694],
                            [-1.8859657218866346, 49.67873492413014],
                            [-1.8859712813597866, 49.678769752177175],
                            [-1.8860032329702108, 49.678769752185275],
                            [-1.8860007821332374, 49.67875417854981],
                            [-1.8860647356806908, 49.67875249744671],
                            [-1.8860650751209391, 49.67874370025382],
                            [-1.88611052239591, 49.67874206752927],
                            [-1.8861080448819223, 49.67872808692067],
                            [-1.8862928433779018, 49.67872300342151],
                            [-1.8862930340980597, 49.678736811463125],
                            [-1.8863760826997975, 49.67873326754946],
                            [-1.8863655631131167, 49.67858584001317],
                            [-1.886287657878114, 49.67858927841809],
                            [-1.8862847634990487, 49.6785407988439],
                            [-1.8862525769906142, 49.67854242596084],
                            [-1.8862421881505327, 49.67838797726381],
                            [-1.8860650205399452, 49.67839484634089],
                            [-1.8860571641159822, 49.678321965852774],
                            [-1.886185429917532, 49.67831860604525],
                        ]
                    ]
                }
            }
        },
        color: BLUE
    },
]

var isDragging = false
var map
var markerElList = []
var startCoords = [-1.878, 49.678638] // lon, lat

const resetObjectSelection = () => {
    markerElList.forEach((markerEl) => {
        markerEl.children[0].classList.remove("workshop-marker-selected")
    })
}

const resetCoords = () => {
    map.flyTo({
            center: startCoords,
            essential: true // this animation is considered essential with respect to prefers-reduced-motion
        });
}

const onMouseDown = () => {
    isDragging = false
}

const onMouseMove = () => {
    isDragging = true
}

const onMouseUp = () => {
    setTimeout(() => {
        if (!isDragging) {
            emit("closeDrawer")
            resetObjectSelection()
            store.dismountWorkshop()
        }
    }, 10)
}

const onWheel = () => { }

onMounted(() => {
    const switchButton = document.getElementById("switch-perspective")
    map = new maplibregl.Map({
        container: 'map',
        zoom: 15,
        maxZoom: 22, // close
        minZoom: 15, // far
        style:
            `https://api.maptiler.com/maps/streets/style.json?key=${import.meta.env.VITE_MAPTILER_API_KEY}`,
        center: startCoords,
        pitch: 55
    })
    map.on('load', () => {
        workshopBuildings.forEach((workshopBuilding) => {
            map.addSource(workshopBuilding.id, workshopBuilding.body)
            map.addLayer({
                'id': workshopBuilding.id,
                'type': 'fill',
                'source': workshopBuilding.id,
                'layout': {},
                'paint': {
                    'fill-color': workshopBuilding.color,
                    'fill-opacity': 0.8
                }
            })
        })
        const layers = map.getStyle().layers
        const buildingLayer = {
            'id': '3d-buildings',
            'source': 'openmaptiles',
            'source-layer': 'building',
            'type': 'fill-extrusion',
            'minzoom': 14,
            //'filter': ['==', ['get', 'hide_3d'], true],
            'filter': ['==', ['id'], 2069741],
            'paint': {
                'fill-extrusion-color': [
                    'interpolate',
                    ['linear'],
                    ['get', 'render_height'], 0, 'lightgray', 200, 'royalblue', 400, 'lightblue'
                ],
                'fill-extrusion-height': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    15,
                    5,
                    16,
                    ['get', 'render_height']
                ],
                'fill-extrusion-base': ['case',
                    ['>=', ['get', 'zoom'], 16],
                    ['get', 'render_min_height'], 0
                ]
            }
        }
        let labelLayerId;
        for (let i = 0; i < layers.length; i++) {
            if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                labelLayerId = layers[i].id;
                break
            }
        }
        map.addLayer(buildingLayer, labelLayerId)
        switchButton.addEventListener("mouseup", () => {
            var pitch = map.transform.pitch
            if (pitch == 0) { // from 2D to 3D
                map.setPitch(55)
                switchButton.innerHTML = "2D"
                map.addLayer(buildingLayer, labelLayerId)
            }
            else { // from 3D to 2D
                map.setPitch(0)
                switchButton.innerHTML = "3D"
                map.removeLayer("3d-buildings")
            }
        })
        var processed_workshops = []
        store.workshops.forEach((workshop) => {
            if (processed_workshops.includes(workshop.workshop))
                return
            processed_workshops.push(workshop.workshop)
            const el = document.createElement('div')
            el.classList = `text-${workshop.color}`
            el.innerHTML = `
            <div class="px-2 py-1 rounded-lg text-white pointer-events-auto cursor-pointer shadow-lg workshop-marker bg-${workshop.color} text-${workshop.color}" style="transform: translate(0, -70%)">
                <div class="font-sm font-bold marker-label text-white">${workshop.workshop}</div>
                <svg width="2em" height="2em" viewBox="0 0 16 16" class="absolute bottom-0 mt-4" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="transform: translate(-50%, 50%); left: 50%" aria-hidden="true"><path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/></svg>
            </div>`
            el.addEventListener('click', () => {
                resetObjectSelection()
                emit("openDrawer")
                store.mountWorkshop(workshop)
                el.children[0].classList.add("workshop-marker-selected")
            })
            markerElList.push(el)
            new maplibregl.Marker({ element: el })
                .setLngLat([workshop.x, workshop.y])
                .addTo(map)
        })
        const mapEl = document.getElementsByClassName("maplibregl-canvas")[0]
        mapEl.addEventListener("mousedown", onMouseDown)
        mapEl.addEventListener("mousemove", onMouseMove)
        mapEl.addEventListener("mouseup", onMouseUp)
        mapEl.addEventListener("wheel", onWheel)
    })
    /*
    // polygon drawing tool
    map.on('click', (e) => {
        document.getElementById('coords').innerHTML += "<br>[" + e.lngLat.lng + ", " + e.lngLat.lat + "],"
    })
    */
})

defineExpose({ resetCoords, resetObjectSelection })
</script>

<template>
    <div id="map" class="w-full"></div>
</template>